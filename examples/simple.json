
{
    "dataspin": {
        "working_dir": "./tmp/working"
    },
    "streams" : [
        {
            "name": "local_simple_data",
            "data_format": "dataspin",
            "url": "watch+local://./temp/"
        }
    ],
    "storages": [
        {
            "name": "simple_target",
            "url": "file://./tmp/target/"
        },
        {
            "name": "simple_target_1",
            "url": "file://./tmp/target_1/"
        },
        {
            "name": "index_target",
            "url": "file://./tmp/index_target/"
        }
    ],
    "dataviews":[
        {
            "table_name": "origin_data",
            "table_file_format": "jsonl",
            "table_file_location": "bytepower-server-data/datalog/origin/",
            "fields": [
                {
                    "name": "app_id",
                    "type": "string",
                    "description": ""
                },
                {
                    "name": "bp_timestamp",
                    "type": "date",
                    "description": ""
                },
                {
                    "name": "event_id",
                    "type": "string",
                    "description": ""
                },
                {
                    "name": "event_name",
                    "type": "string",
                    "description": ""
                },
                {
                    "name" :"device",
                    "type": "object",
                    "description": "",
                    "properties":[
                        {
                            "name": "brand",
                            "type": "string",
                            "description": ""
                        },{
                            "name": "os_type",
                            "type": "string",
                            "description": ""
                        },{
                            "name": "os_version",
                            "type": "string",
                            "description": ""
                        }
                    ]
                }
            ]
        },
        {
            "table_name": "pk_index",
            "table_file_format": "jsonl",
            "table_file_location": "bytepower-server-data/dataspin/pk-index/",
            "fields": [
                {
                    "name": "event_id",
                    "type": "string",
                    "description": ""
                },{
                    "name": "app_id",
                    "type": "string",
                    "description": ""
                }
            ]
        }
    ]
    ,
    "data_processes":[
        {
            "name": "split and build index",
            "description": "",
            "source": "local_simple_data",
            "index_source": "index_target",
            "processes":[
                {
                    "name":"split by app_id",
                    "function": "splitby",
                    "args": {
                        "key": ["app_id"]
                    }
                },
                {
                    "name": "build primary key index",
                    "function": "pk_index",
                    "args": {
                        "key": ["app_id","event_id"]
                    }
                },
                {
                    "name": "deduplicate by event_id",
                    "function": "deduplicate",
                    "args": {
                        "key": ["event_id"],
                        "slide_window": "24h-now"
                    }
                },
                {
                    "name": "flatten json",
                    "function": "flatten"
                },
                {
                    "name": "save to target",
                    "function": "save",
                    "args": {
                        "location": "simple_target"
                    }
                },
                {
                    "name": "save to target 1",
                    "function": "save",
                    "args": {
                        "location": "simple_target_1"
                    }
                },
                {
                    "name": "save to index target",
                    "function": "save",
                    "args": {
                        "location": "index_target"
                    }
                }
            ],
            "process_flow":[
                {
                    "split by app_id":
                        [
                            {
                                "build primary key index":"save to index target"
                            },
                            {
                                "deduplicate by event_id":{
                                    "flatten json":["save to target","save to target 1"]
                                }
                            }
                        ]
                }
            ]
        }
    ]
}